## 대기열 구현 방안

현재까지 생각으로 콘서트 예약 시나리오에서 대기열이 필요한 이유는 좌석 관리를 위해 데이터 베이스에서 동시성 제어를 하게 될텐데 많은 숫자의 예약 신청이 데이터베이스로의 접근이 쏟아지는 것을 관리하기 위함이라고 생각을 하고 있습니다. 

그렇다면 대기열의 책임은 예약이 가능한지 좌석이 남았는지와 같은 조건들과는 아무 관계가 없고 단순히 예약을 위해 들어오는 요청들을 대기시키는 것 이상 그 이하도 아니라고 생각하고 있습니다.

그리고, 대기열이 존재함에도 불구하고, 데이터베이스로의 접근이 쏟아지는 것을 방지하기 위해 예약이 가능한 상태 즉, 활성화된 토큰의 숫자를 제한할 생각입니다. 

이를 위해 생각한 구조는 아래와 같습니다.

- 토큰 발급 요청을 받으면 대기열에 토큰을 push 하고, 데이터베이스에 해당 토큰의 정보를 status는 대기중으로 하여 저장 후, client에 대기 상태라는 것을 응답한다.
    - 클라이언트의 네트워크 문제와 같은 것으로 인해 오랜 기간 남아있는 것을 방지하기 위해 특정 시간 동안 활성화가 되지않으면 expire 하는 로직을 추가함.
    - 어차피 redis를 사용할 것이라면 굳이 토큰 정보를 데이터베이스에 저장할 필요가 있을까?
- 클라이언트는 받은 응답이 대기 중이라면 주기적으로 polling 요청을 서버로 해서 토큰의 status를 확인하는 요청을 보내고, 서버는 토큰의 status가 유효한 경우 유효하다고 응답하고, 아직 대기중이라면 약 몇 번째 순서인지를 함께 클라이언트로 보낸다.
    - 큐에서 해당 토큰의 인덱스가 몇인지 조회해서 함께 보낼 생각입니다.
- 백그라운드 프로세스가 주기적으로 현재 활성화된 토큰의 숫자를 조회해서 특정 숫자(예. 200개) 이하이면 대기열에서 토큰들을 꺼내 대기중에서 활성화로 변경합니다.
    - 활성화된 토큰을 추적할 수 있도록 따로 저장을 하려고 합니다.
    - 토큰이 활성화 됨과 동시에 특정 시간 동안 예약을 하지 않으면 만료시킬 수 있도록 함.
- 클라이언트는 polling 요청을 통해 토큰이 활성화 되었음을 확인했으면 해당 토큰과 함께 예약 및 좌석 조회를 할 수 있는 권한이 생긴다.
