## 대기열 구현 방안

### 시퀀스 다이어그램

![20240402_211249](https://github.com/dlwlsh92/concert-reservation/assets/102504924/7d5dd37e-b399-4d64-8db8-e5b5472bc96a)

현재까지 생각으로 콘서트 예약 시나리오에서 대기열이 필요한 이유는 좌석 관리를 위해 데이터 베이스에서 동시성 제어를 하게 될텐데 많은 숫자의 예약 신청이 데이터베이스로의 접근이 쏟아지는 것을 관리하기 위함이라고 생각을 하고 있습니다. 

그렇다면 대기열의 책임은 예약이 가능한지 좌석이 남았는지와 같은 조건들과는 아무 관계가 없고 단순히 예약을 위해 들어오는 요청들을 대기시키는 것 이상 그 이하도 아니라고 생각하고 있습니다.

그리고, 대기열이 존재함에도 불구하고, 데이터베이스로의 접근이 쏟아지는 것을 방지하기 위해 예약이 가능한 상태 즉, 활성화된 토큰의 숫자를 제한할 생각입니다. 

이를 위해 생각한 구조는 아래와 같습니다.

1. 서버로 예약 토큰 발급 요청을 함.
    1. 대기열에 토큰을 push하고, 데이터베이스에 해당 토큰의 정보를 저장한다. 이 때, 토큰의 status는 pending이고, client에게 토큰 정보를 응답한다.
    2. 토큰에는 현재 대기 순서를 함께 저장함.

2. 클라이언트는 주기적으로 서버에 폴링 요청을 해서 자신의 토큰 상태를 조회함.
    1. 토큰 상태가 pending이라면 함께 받은 대기 순서를 유저에게 보여주면서 대기할 수 있도록 함.
        1. redis에 마지막으로 queue에서 나온 토큰의 대기 번호를 함께 저장해서 폴링 요청 시 자신의 토큰 대기 순서와 마지막 토큰 대기 번호의 차이를 계산하여 현재 대기 순서가 얼마인지 클라이언트에게 함께 보냄.
    2. 토큰 상태가 available이라면 예약 가능 날짜/좌석 조회 페이지로 이동시킴.

3. 서버는 백그라운드 프로세스가 주기적으로 현재 활성화된 토큰의 숫자를 조회해서 특정 숫자(ex. 200개) 이하이면 대기열에서 토큰들을 꺼내 pending에서 available로 변경한다.
    1. 이 때, 데이터베이스의 reservationToken의 status도 함께 available로 변경하여 polling 시 status를 조회할 수 있도록 함.
    2. 대기열이 있다고 해도 데이터베이스로의 접근에 제한을 두기 위함인데 적절한 판단인지
    3. 활성화된 토큰을 추적할 수 있도록 따로 기록을 하는 것이 맞는지
    4. 토큰이 활성화 됨과 동시에 특정 시간동안 예약 및 결제를 하지 않으면 expire 할 수 있도록 함.

4. 잔액 조회/충전을 제외한 예약 및 좌석 조회, 예약, 결제는 모두 예약 토큰의 status가 available인 경우에만 할 수 있도록 토큰을 항상 검증함.

## ERD
![drawSQL-image-export-2024-04-02](https://github.com/dlwlsh92/concert-reservation/assets/102504924/1b99f94e-4261-4a97-a555-4eecb3bf0d56)


enum TokenStatus {
  expired
  pending
  available
}

enum SeatStatus {
  reserved
  available
}
